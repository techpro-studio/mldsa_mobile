name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Grant execute permission for gradlew
      working-directory: android
      run: chmod +x gradlew

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    - name: Build AAR
      working-directory: android
      run: ./gradlew clean :app:assembleRelease

    - name: Rename AAR
      run: |
        mkdir -p release-artifacts
        cp android/app/build/outputs/aar/app-release.aar release-artifacts/mldsa-android.aar

    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: aar-artifact
        path: release-artifacts/mldsa-android.aar

  build-xcframework:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Install CMake
      run: brew install cmake

    - name: Grant execute permission for build script
      run: chmod +x build_apple.sh

    - name: Build XCFramework
      run: ./build_apple.sh

    - name: Create XCFramework archive
      run: |
        mkdir -p release-artifacts
        cd test/libs
        zip -r ../../release-artifacts/mldsa-xcframework.zip MLDSA.xcframework

    - name: Upload XCFramework artifact
      uses: actions/upload-artifact@v4
      with:
        name: xcframework-artifact
        path: release-artifacts/mldsa-xcframework.zip

  create-release:
    needs: [android-tests, build-aar, build-xcframework]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download AAR artifact
      uses: actions/download-artifact@v4
      with:
        name: aar-artifact
        path: release-artifacts

    - name: Download XCFramework artifact
      uses: actions/download-artifact@v4
      with:
        name: xcframework-artifact
        path: release-artifacts

    - name: Get tag name
      id: get_tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_tag.outputs.tag }}
        name: Release ${{ steps.get_tag.outputs.tag }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          release-artifacts/mldsa-android.aar
          release-artifacts/mldsa-xcframework.zip
